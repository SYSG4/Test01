using System.Collections;
using System.Collections.Generic;
using System;
using UnityEngine;
using TMPro;
public class TileEventHandler : MonoBehaviour
{
    int[,,,] TileUse = new int[2,31,4,6]{
        // A-0,B-0はデバッグ用の盤面(ほぼ全域白)
        {
            {
                {0,1,1,1,1,1},
                {0,1,1,1,1,1},
                {0,1,1,1,1,1},
                {0,1,1,1,1,1},
            },
            {
                //A-1
                {0,0,1,1,1,1},
                {0,1,1,1,1,1},
                {0,0,1,1,1,1},
                {0,0,0,0,1,0},
            },
            {
                {0,0,1,1,1,1},
                {0,0,0,1,1,1},
                {0,1,1,1,1,1},
                {0,0,0,0,1,1},
            },
            {
                {0,0,0,0,0,0},
                {0,0,0,1,1,1},
                {0,1,1,1,1,1},
                {1,1,1,1,1,1},
            },
            {
                {0,1,1,1,0,0},
                {1,1,1,1,1,1},
                {0,0,1,1,1,0},
                {0,0,1,1,0,0},
            },
            {
                // A-5
                {0,0,1,1,1,1},
                {0,0,1,1,1,1},
                {1,1,1,1,1,0},
                {0,0,0,0,1,0},
            },
            {
                {0,0,1,1,1,0},
                {0,1,1,1,1,1},
                {0,1,1,1,0,0},
                {0,1,1,1,0,0},
            },
            {
                {0,0,0,0,1,1},
                {0,1,1,1,1,0},
                {0,1,1,1,1,0},
                {1,1,1,1,0,0},
            },
            {
                {1,1,1,1,0,0},
                {0,1,1,1,0,0},
                {0,1,1,1,1,1},
                {0,0,1,1,0,0},
            },
            {
                {1,1,1,1,0,0},
                {1,1,1,1,1,1},
                {1,1,1,0,0,0},
                {0,1,0,0,0,0},
            },
            {
                // A-10
                {0,1,1,0,0,0},
                {0,1,1,1,1,0},
                {0,1,1,1,1,1},
                {0,1,1,1,0,0},
            },
            {
                {0,0,1,0,0,0},
                {0,1,1,1,1,1},
                {0,1,1,1,1,1},
                {0,0,1,1,1,0},
            },
            {
                {0,0,0,0,0,0},
                {1,1,1,1,1,0},
                {1,1,1,1,1,1},
                {0,0,1,1,1,0},
            },
            {
                {1,1,1,1,1,1},
                {0,1,1,1,1,0},
                {0,1,1,1,0,0},
                {0,0,0,1,0,0},
            },
            {
                {0,0,1,1,1,1},
                {0,1,1,1,1,1},
                {0,0,1,1,1,0},
                {0,0,1,1,0,0},
            },
            {
                // A-15
                {0,0,0,0,0,0},
                {0,1,1,1,1,1},
                {1,1,1,1,0,0},
                {1,1,1,1,1,0},
            },
            {
                {0,0,0,0,0,0},
                {0,1,1,1,1,0},
                {0,1,1,1,1,1},
                {0,1,1,1,1,1},
            },
            {
                {0,1,1,1,1,0},
                {0,1,1,1,1,0},
                {0,1,1,1,1,1},
                {0,1,0,0,0,0},
            },
            {
                {0,0,0,1,1,0},
                {0,0,1,1,1,1},
                {0,1,1,1,1,1},
                {0,1,1,1,0,0},
            },
            {
                {0,0,1,1,1,1},
                {0,1,1,1,1,0},
                {0,1,1,1,1,0},
                {0,0,1,1,0,0},
            },
            {
                // A-20
                {0,0,0,0,0,0},
                {0,1,1,1,1,1},
                {0,1,1,1,1,0},
                {0,0,1,1,1,1},
            },
            {
                {0,0,0,1,1,0},
                {0,1,1,1,1,1},
                {0,0,1,1,1,0},
                {0,1,1,1,0,0},
            },
            {
                {0,1,1,1,1,1},
                {0,1,1,1,0,0},
                {0,1,1,1,0,0},
                {0,1,0,1,0,0},
            },
            {
                {0,1,1,1,1,0},
                {0,0,1,1,1,1},
                {0,0,0,1,1,0},
                {0,0,1,1,1,0},
            },
            {
                {0,0,1,1,1,1},
                {0,0,1,1,1,0},
                {0,1,1,1,0,0},
                {0,1,1,1,0,0},
            },
            {
                // A-25
                {0,1,1,1,1,0},
                {0,1,1,1,1,1},
                {0,1,1,1,0,0},
                {0,0,1,0,0,0},
            },
            {
                {0,0,0,1,1,1},
                {0,1,1,1,1,0},
                {0,1,1,1,1,1},
                {0,0,1,0,0,0},
            },
            {
                {0,0,1,1,0,0},
                {0,0,1,1,0,0},
                {0,1,1,1,1,0},
                {0,1,1,1,1,1},
            },
            {
                {0,1,1,0,0,0},
                {0,1,1,1,1,1},
                {0,1,1,1,1,0},
                {0,1,1,0,0,0},
            },
            {
                {0,1,1,1,1,0},
                {0,0,1,1,1,1},
                {0,0,1,1,1,1},
                {0,0,1,0,0,0},
            },
            {
                // B-30
                {0,0,0,1,0,0},
                {0,0,1,1,1,0},
                {0,1,1,1,1,1},
                {0,1,1,1,1,0},
            },
        },
        // A盤面終わり
        // ===========================================================================================================================================
        // B盤面ここから
        {
            {
                {1,1,1,1,1,1},
                {1,1,1,1,1,1},
                {1,1,1,1,1,1},
                {1,1,1,1,1,1},
            },
            {
                // B-1
                {0,1,1,1,1,0},
                {1,1,1,1,0,0},
                {1,1,1,1,0,0},
                {1,1,1,1,1,1},
            },
            {
                {1,0,1,1,1,0},
                {1,0,1,1,1,0},
                {1,1,1,1,1,1},
                {1,1,1,1,0,0},
            },
            {
                {1,0,0,0,1,1},
                {1,0,0,1,1,1},
                {1,1,1,1,1,1},
                {1,1,1,1,1,0},
            },
            {
                {0,1,1,0,1,0},
                {0,1,1,1,1,1},
                {0,1,1,1,1,1},
                {0,1,1,1,1,1},
            },
            {
                // B-5
                {1,1,1,0,0,0},
                {1,1,1,1,1,0},
                {1,1,1,1,1,1},
                {1,0,1,1,1,0},
            },
            {
                {1,1,1,1,1,0},
                {1,1,1,0,0,0},
                {1,1,1,1,1,0},
                {0,1,1,1,1,1},
            },
            {
                {0,1,1,1,0,0},
                {1,1,1,1,1,0},
                {1,1,1,1,1,1},
                {1,1,1,1,0,0},
            },
            {
                {0,1,1,1,1,0},
                {0,1,1,1,1,1},
                {0,0,1,1,1,0},
                {1,1,1,1,1,1},
            },
            {
                {0,1,1,1,1,0},
                {1,1,1,1,1,1},
                {0,1,1,1,1,1},
                {0,1,1,1,0,0},
            },
            {
                // B-10
                {0,0,1,1,1,1},
                {1,1,1,1,1,1},
                {0,0,1,1,1,1},
                {0,1,1,1,0,1},
            },
            {
                {1,1,1,0,0,0},
                {1,1,1,0,1,1},
                {0,1,1,1,1,1},
                {0,1,1,1,1,1},
            },
            {
                {1,1,1,1,0,0},
                {0,0,1,1,1,1},
                {1,1,1,1,1,1},
                {0,1,1,1,0,1},
            },
            {
                {0,0,0,1,1,1},
                {1,1,1,1,1,1},
                {0,0,1,1,1,1},
                {0,1,1,1,1,1},
            },
            {
                {0,0,1,1,1,1},
                {0,0,0,1,1,1},
                {1,1,1,1,1,1},
                {1,1,1,1,0,1},
            },
            {
                // B-15
                {0,1,1,1,1,0},
                {1,1,1,1,1,1},
                {1,1,1,1,1,0},
                {1,1,1,0,0,0},
            },
            {
                {0,1,1,1,1,0},
                {0,1,1,1,0,0},
                {1,1,1,1,1,1},
                {1,1,1,1,1,0},
            },
            {
                {0,1,1,0,0,0},
                {1,1,1,1,1,1},
                {1,1,1,1,1,0},
                {1,1,1,1,1,0},
            },
            {
                {0,1,1,1,1,0},
                {1,1,1,1,1,0},
                {1,1,1,1,1,1},
                {0,1,0,1,1,0},
            },
            {
                {0,0,1,1,1,1},
                {0,1,1,1,1,1},
                {1,1,1,1,1,0},
                {0,0,1,1,1,1},
            },
            {
                // B-20
                {0,1,0,0,0,1},
                {1,1,1,1,1,1},
                {1,1,1,1,1,1},
                {1,1,1,0,1,0},
            },
            {
                {0,1,1,1,0,0},
                {1,1,1,1,0,0},
                {1,1,1,1,1,0},
                {1,1,1,1,1,1},
            },
            {
                {1,0,1,1,1,1},
                {1,1,1,1,1,1},
                {1,1,1,1,1,0},
                {0,0,1,1,0,0},
            },
            {
                {0,1,0,0,1,1},
                {1,1,1,1,1,1},
                {0,1,1,1,1,1},
                {0,0,1,1,1,1},
            },
            {
                {0,0,0,0,1,0},
                {1,1,1,1,1,1},
                {1,1,1,1,1,1},
                {1,1,1,1,0,1},
            },
            {
                // B-25
                {0,1,1,1,1,0},
                {1,1,1,1,1,1},
                {0,1,1,1,0,0},
                {0,1,1,1,1,1},
            },
            {
                {0,1,1,1,1,1},
                {0,0,1,1,1,1},
                {0,1,1,1,1,1},
                {0,0,1,1,1,1},
            },
            {
                {1,1,0,1,1,0},
                {1,1,1,1,0,0},
                {1,1,1,1,1,1},
                {1,1,1,1,0,0},
            },
            {
                {0,1,1,1,1,0},
                {0,1,1,1,1,0},
                {1,1,1,1,1,0},
                {0,1,1,1,1,1},
            },
            {
                {1,0,0,0,0,0},
                {1,1,1,1,1,0},
                {1,1,1,1,1,1},
                {1,1,1,1,1,1},
            },
            {
                // B-30
                {0,0,0,0,1,1},
                {0,1,1,1,1,1},
                {0,1,1,1,1,1},
                {1,1,1,1,1,1},
            },
        }
    };

    [SerializeField] TextMeshProUGUI Stagetext;
    [SerializeField] TextMeshProUGUI Timer;

    GameObject[] Pieces;
    double time;
    bool stop = false;
    public int type, stage;
    void Start()
    {
        time = 0;
        Pieces = GameObject.FindGameObjectsWithTag("Piece");
    }
    private void Update()
    {
        if(stop == false)
            time += Time.deltaTime;
            Timer.text = ($"{Math.Floor(time/60)}:{Math.Round(time % 60 ,2 ,  MidpointRounding.AwayFromZero).ToString("00.00")}");

        if (Input.GetKeyDown(KeyCode.Space))
        {
            time = 0;
            stop = false;
            stage += 1;
            if (stage == 31)
            {
                type = 1 - type;
            }
            stage = stage % 31;
            if (type == 0)
                Stagetext.text = $"A-{stage}";
            else
                Stagetext.text = $"B-{stage}";

            TileUpdate();
            for(int i = 0; i < Pieces.GetLength(0); i++){
                Pieces[i].GetComponent<PositionReset>().Reset();
                Pieces[i].GetComponent<DropParent>().Settarget();
                Pieces[i].GetComponent<ShapeSizeHandler>().OnMouseDrag();
            }
        }
    }

    private void TileUpdate()
    {
        for (int i = 0; i < TileUse.GetLength(2); i++)
        {
            for (int j = 0; j < TileUse.GetLength(3); j++)
            {
                if (TileUse[type, stage, i, j] == 0)
                {
                    GameObject.Find($"Tile{i}{j}").GetComponent<Renderer>().material.color = Color.black;
                    GameObject.Find($"Tile{i}{j}").tag = "Nonuse";
                }
                else
                {
                    GameObject.Find($"Tile{i}{j}").GetComponent<Renderer>().material.color = Color.white;
                    GameObject.Find($"Tile{i}{j}").tag = "Use";
                }
            }
        }
    }

    public void Cleardecision()
    {
        for (int i = 0; i < TileUse.GetLength(2); i++)
        {
            for (int j = 0; j < TileUse.GetLength(3); j++)
            {
                if (GameObject.Find($"Tile{i}{j}").tag == "Use")
                {
                    GameObject.Find("Clearbox").GetComponent<Renderer>().material.color = Color.white;
                    return;
                }
            }
        }
        stop = true;
        GameObject.Find("Clearbox").GetComponent<Renderer>().material.color = Color.red;
    }
}

// using UnityEngine.SceneManagement;
// SceneManager.LoadScene (SceneManager.GetActiveScene().name);

// スコアやタイムの保持について https://www.sejuku.net/blog/69991
